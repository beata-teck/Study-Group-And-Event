<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Event Details - StudyFinder</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="css/styles.css">
    <style>
        .event-hero {
            position: relative;
            height: 320px;
            overflow: hidden;
        }

        .event-hero img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .event-hero::after {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(to top, rgba(0, 0, 0, 0.6), transparent);
        }

        .event-content {
            padding: 2rem;
        }

        .event-header {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        @media (min-width: 640px) {
            .event-header {
                flex-direction: row;
                justify-content: space-between;
            }
        }

        .event-title {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--slate-900);
            margin-bottom: 0.5rem;
        }

        .event-organizer {
            color: var(--slate-500);
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(1, 1fr);
            gap: 1rem;
            margin-bottom: 2rem;
        }

        @media (min-width: 640px) {
            .info-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        .info-card {
            display: flex;
            align-items: center;
            padding: 1rem;
            background: var(--slate-50);
            border-radius: 12px;
        }

        .info-icon {
            width: 40px;
            height: 40px;
            background: rgba(79, 70, 229, 0.1);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 0.75rem;
        }

        .info-icon svg {
            width: 20px;
            height: 20px;
            color: var(--primary);
        }

        .info-label {
            font-size: 0.75rem;
            color: var(--slate-500);
        }

        .info-value {
            font-weight: 600;
            color: var(--slate-900);
        }

        .participants-box {
            display: flex;
            align-items: center;
            padding: 1rem;
            background: #f0fdf4;
            border-radius: 12px;
            margin-bottom: 1.5rem;
        }

        .participants-box svg {
            width: 20px;
            height: 20px;
            color: var(--green-600);
            margin-right: 0.5rem;
        }

        .participants-box span {
            color: #15803d;
            font-weight: 500;
        }

        .description-section h2 {
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 0.75rem;
        }

        .description-text {
            color: var(--slate-600);
            line-height: 1.7;
            white-space: pre-wrap;
        }

        .back-link {
            display: inline-flex;
            align-items: center;
            font-size: 0.875rem;
            color: var(--slate-500);
            margin-bottom: 1.5rem;
        }

        .back-link:hover {
            color: var(--primary);
        }

        .back-link svg {
            width: 16px;
            height: 16px;
            margin-right: 0.25rem;
        }
    </style>
</head>

<body>
    <nav class="navbar">
        <div class="container navbar-inner">
            <a href="index.html" class="logo">
                <div class="logo-icon"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z">
                        </path>
                    </svg></div>
                <span class="logo-text">StudyFinder</span>
            </a>
            <div class="nav-links">
                <a href="index.html" class="nav-link">Discover</a>
                <a href="create_event.html" class="nav-link" id="navCreateEvent">Create Event</a>
                <a href="calendar.html" class="nav-link" id="navCalendar">My Calendar</a>
            </div>
            <div class="nav-actions">
                <div id="loggedOutMenu"><a href="login.html" class="nav-link">Login</a><a href="signup.html"
                        class="btn btn-primary">Sign Up</a></div>
                <div class="nav-user hidden" id="loggedInMenu"><span>Hello, <strong id="userName">User</strong></span><a
                        href="#" class="nav-link" id="logoutBtn" style="color: var(--red-500);">Logout</a></div>
            </div>
        </div>
    </nav>

    <main class="container py-8">
        <a href="index.html" class="back-link"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
            </svg>Back to Events</a>

        <div class="form-card" style="padding: 0; overflow: hidden;">
            <div class="event-hero">
                <img id="eventImage"
                    src="https://images.unsplash.com/photo-1523050854058-8df90110c9f1?w=800&h=400&fit=crop" alt="">
                <span class="card-category study" id="eventCategory"
                    style="position: absolute; top: 16px; left: 16px; z-index: 1;">Study</span>
            </div>

            <div class="event-content">
                <div class="event-header">
                    <div>
                        <h1 class="event-title" id="eventTitle">Loading...</h1>
                        <p class="event-organizer" id="eventOrganizer">Organized by ...</p>
                    </div>
                    <button id="joinBtn" class="btn btn-primary btn-lg">Join Event</button>
                </div>

                <div class="info-grid">
                    <div class="info-card">
                        <div class="info-icon"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z">
                                </path>
                            </svg></div>
                        <div>
                            <p class="info-label">Date</p>
                            <p class="info-value" id="eventDate">-</p>
                        </div>
                    </div>
                    <div class="info-card">
                        <div class="info-icon"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg></div>
                        <div>
                            <p class="info-label">Time</p>
                            <p class="info-value" id="eventTime">-</p>
                        </div>
                    </div>
                    <div class="info-card">
                        <div class="info-icon"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z">
                                </path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                            </svg></div>
                        <div>
                            <p class="info-label">Location</p>
                            <p class="info-value" id="eventLocation">-</p>
                        </div>
                    </div>
                </div>

                <div class="participants-box">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z">
                        </path>
                    </svg>
                    <span id="participantCount">0 participants joined</span>
                </div>

                <h2>About this Event</h2>
                <p class="description-text" id="eventDescription">No description provided.</p>
            </div>

            <div class="description-section"
                style="margin-top: 2rem; padding-top: 2rem; border-top: 1px solid var(--slate-200);">
                <h2>Discussion</h2>

                <div id="commentsList" style="margin-bottom: 2rem; display: flex; flex-direction: column; gap: 1rem;">
                    <!-- Comments will be loaded here -->
                    <p class="text-slate-500 italic">No comments yet. Be the first to start the discussion!</p>
                </div>

                <div id="commentFormArea">
                    <textarea id="commentInput" class="form-input" rows="3"
                        placeholder="Ask a question or share study materials..."></textarea>
                    <button id="postCommentBtn" class="btn btn-primary mt-2">Post Comment</button>
                </div>
                <div id="loginToComment" class="hidden text-center p-4 bg-slate-50 rounded-lg">
                    <p>Please <a href="login.html" class="text-primary font-bold">login</a> to participate in the
                        discussion.</p>
                </div>
            </div>
        </div>
        </div>
    </main>

    <footer class="footer">
        <div class="container">
            <div class="footer-bottom" style="border:none;margin:0;padding:0;">
                <p>&copy; 2026 StudyFinder</p>
            </div>
        </div>
    </footer>

    <script src="js/app.js"></script>
    <script>
        let eventData = null;
        let isJoined = false;
        const eventId = new URLSearchParams(window.location.search).get('id');

        async function loadEvent() {
            if (!eventId) { window.location.href = 'index.html'; return; }
            try {
                const response = await fetch(`${API_BASE}/events.php?id=${eventId}`);
                const data = await response.json();
                if (data.success && data.data) { eventData = data.data; renderEvent(); }
                else { window.location.href = 'index.html'; }
            } catch (e) { console.error(e); }
        }

        function renderEvent() {
            document.title = `${eventData.title} - StudyFinder`;
            const imageUrl = eventData.image_path ? `../backend/uploads/${eventData.image_path}` : 'https://images.unsplash.com/photo-1523050854058-8df90110c9f1?w=800&h=400&fit=crop';
            document.getElementById('eventImage').src = imageUrl;
            const catEl = document.getElementById('eventCategory');
            catEl.textContent = eventData.category;
            catEl.className = `card-category ${eventData.category.toLowerCase()}`;
            document.getElementById('eventTitle').textContent = eventData.title;
            document.getElementById('eventOrganizer').textContent = `Organized by ${eventData.creator_name || 'Unknown'}`;
            document.getElementById('eventDate').textContent = new Date(eventData.event_date).toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            document.getElementById('eventTime').textContent = eventData.event_time ? new Date(`2000-01-01T${eventData.event_time}`).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' }) : 'TBD';
            document.getElementById('eventLocation').textContent = eventData.location || 'TBD';
            document.getElementById('eventDescription').textContent = eventData.description || 'No description provided.';
            document.getElementById('participantCount').textContent = `${eventData.participant_count || 0} participants joined`;

            // Show Edit/Delete if owner
            if (currentUser && (currentUser.id == eventData.created_by || currentUser.role === 'admin')) {
                const headerDiv = document.querySelector('.event-header div:last-child');
                // Or just append near the Join button
                // But headerDiv targets the Join button container if flex row logic is checked?
                // Actually the structure is:
                // .event-header
                //    div (Title, Org)
                //    button#joinBtn

                // We want to add buttons next to Join button or replace it? No, owner can join too?
                // Owner probably shouldn't join. But let's keep it simple.
                // Insert specific admin controls div.

                const controls = document.createElement('div');
                controls.className = 'mt-4 flex gap-2';
                controls.innerHTML = `
                    <button id="editBtn" class="btn btn-secondary" onclick="window.location.href='create_event.html?id=${eventData.id}'">Edit Event</button>
                    <button id="deleteBtn" class="btn btn-danger" onclick="deleteEvent()">Delete Event</button>
                `;

                // Add styling for secondary btn if missing, or use inline
                // event-content is parent of event-header.
                // Let's put it below title/organizer?
                document.querySelector('.event-header > div:first-child').appendChild(controls);
            }

            // Init Comments UI
            if (currentUser) {
                document.getElementById('commentFormArea').classList.remove('hidden');
                document.getElementById('loginToComment').classList.add('hidden');
            } else {
                document.getElementById('commentFormArea').classList.add('hidden');
                document.getElementById('loginToComment').classList.remove('hidden');
            }
            loadComments();
        }

        async function deleteEvent() {
            if (!confirm('Are you sure you want to delete this event?')) return;
            try {
                const response = await fetch(`${API_BASE}/events.php?id=${eventData.id}`, {
                    method: 'DELETE',
                    headers: { 'x-user-id': currentUser.id }
                });
                const data = await response.json();
                if (data.success) {
                    alert('Event deleted.');
                    window.location.href = 'index.html';
                } else {
                    alert('Failed to delete: ' + data.message);
                }
            } catch (e) {
                console.error(e);
                alert('Error deleting event.');
            }
        }

        async function loadComments() {
            try {
                const response = await fetch(`${API_BASE}/comments.php?event_id=${eventId}`);
                const data = await response.json();
                const list = document.getElementById('commentsList');
                if (data.success && data.data && data.data.length > 0) {
                    list.innerHTML = data.data.map(c => `
                        <div class="bg-slate-50 p-4 rounded-lg">
                            <div class="flex justify-between items-start mb-2">
                                <span class="font-bold text-slate-900">${escapeHtml(c.user_name)} <span class="text-xs font-normal text-slate-500 bg-slate-200 px-2 py-0.5 rounded ml-2">${c.role}</span></span>
                                <span class="text-xs text-slate-500">${new Date(c.created_at).toLocaleDateString()} ${new Date(c.created_at).toLocaleTimeString()}</span>
                            </div>
                            <p class="text-slate-700 whitespace-pre-wrap">${escapeHtml(c.comment)}</p>
                        </div>
                    `).join('');
                } else {
                    list.innerHTML = '<p class="text-slate-500 italic">No comments yet. Be the first to start the discussion!</p>';
                }
            } catch (e) {
                console.error(e);
            }
        }

        function escapeHtml(text) {
            if (!text) return '';
            return text
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        document.getElementById('postCommentBtn')?.addEventListener('click', async () => {
            if (!currentUser) {
                window.location.href = 'login.html';
                return;
            }
            const input = document.getElementById('commentInput');
            const comment = input.value.trim();
            if (!comment) return;

            const btn = document.getElementById('postCommentBtn');
            btn.disabled = true;
            btn.textContent = 'Posting...';

            try {
                const response = await fetch(`${API_BASE}/comments.php`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-user-id': currentUser.id
                    },
                    body: JSON.stringify({ event_id: eventId, comment })
                });
                const data = await response.json();
                if (data.success) {
                    input.value = '';
                    loadComments();
                } else {
                    alert('Failed to post: ' + data.message);
                }
            } catch (e) {
                console.error(e);
                alert('Network error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Post Comment';
            }
        });

        document.getElementById('joinBtn').addEventListener('click', async () => {
            if (!currentUser) { window.location.href = 'login.html'; return; }
            const btn = document.getElementById('joinBtn');
            btn.disabled = true;
            const result = await toggleJoinEvent(eventId, isJoined ? 'leave' : 'join');
            if (result.success) {
                isJoined = !isJoined;
                btn.textContent = isJoined ? 'Leave Event' : 'Join Event';
                btn.className = isJoined ? 'btn btn-danger btn-lg' : 'btn btn-primary btn-lg';
                document.getElementById('participantCount').textContent = `${result.participant_count} participants joined`;
            }
            btn.disabled = false;
        });

        document.getElementById('logoutBtn')?.addEventListener('click', (e) => { e.preventDefault(); logout(); });
        document.addEventListener('DOMContentLoaded', () => { checkAuth(); loadEvent(); });
    </script>
</body>

</html>